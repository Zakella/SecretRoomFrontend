@if (product()) {
  <section class="product-page" appFadeUp>
    <button class="back-btn-mobile" (click)="navigateToList()" aria-label="Назад">
      <img src="assets/images/back.svg" alt="Назад" />
    </button>
    <button class="back-btn-desktop" (click)="navigateToList()">
      <i class="ri-arrow-left-line"></i>
      <span>{{ 'Back' | transloco }}</span>
    </button>

    <div class="product-grid">
      <div class="product-images">
        <div class="main-image">
          <img [src]="mainImage" [alt]="product() | localizedName"/>
        </div>
        @defer {
          <div class="thumbnails">
            @for (image of product()!.productImagesWebStore; track image) {
              <img src="{{image.imageUrl}}"
                   [alt]="(product() | localizedName) + ' - ' + ($index + 1)"
                   loading="lazy"
                   [ngClass]="{'active': mainImage === image.imageUrl}"
                   (click)="mainImage = image.imageUrl || 'assets/images/unavailable.jpg'"
              />
            }
          </div>
        }
      </div>

        <div class="product-info">
          <div class="product-header">
            <span class="brand">{{ product()?.brandAlias | capitalize }}</span>
            <h1>{{ product() | localizedName | capitalize }}</h1>

            <product-price
              [price]="selectedVariant()?.price ?? product()!.price"
              [oldPrice]="selectedVariant()?.oldPrice ?? product()!.oldPrice"
              size="lg"/>

            @if (isDiscontinued()) {
              <div class="stock-warning stock-discontinued">
                <i class="ri-forbid-2-fill"></i>
                <span>{{ 'DiscontinuedMessage' | transloco }}</span>
              </div>
            } @else if (isOutOfStock()) {
              <div class="stock-warning stock-out">
                <i class="ri-close-circle-fill"></i>
                <span>{{ 'OutOfStockMessage' | transloco }}</span>
              </div>
            } @else if (effectiveStock() === 1) {
              <div class="stock-warning stock-critical">
                <i class="ri-error-warning-fill"></i>
                <span>{{ 'LastItemHurry' | transloco }}</span>
              </div>
            } @else if (effectiveStock() !== undefined && effectiveStock()! <= 3 && effectiveStock()! > 0) {
              <div class="stock-warning stock-low">
                <i class="ri-fire-fill"></i>
                <span>{{ 'LowInStockDetail' | transloco }}</span>
              </div>
            }

            @if (selectedVariant()?.article || product()?.article) {
              <span class="article">{{ 'Article' | transloco }}: {{ selectedVariant()?.article ?? product()?.article }}</span>
            }
          </div>

          @if (product() | localizedName:'description') {
            <div class="description" [innerHTML]="(product() | localizedName:'description') | capitalize"></div>
          }

          @if (product()?.filters?.length) {
            <div class="product-specs">
              <h3>{{ 'Characteristics' | transloco }}</h3>
              @for (f of product()!.filters; track f.valueSlug) {
                <div class="spec-row">
                  <span class="spec-label">{{ f | localizedName:'filterName' }}</span>
                  <span class="spec-value">{{ f | localizedName:'value' }}</span>
                </div>
              }
            </div>
          }

          @if (product()?.compositions?.length) {
            <div class="product-composition">
              <h3>{{ 'Composition' | transloco }}</h3>
              @for (c of product()!.compositions; track $index) {
                <p>{{ c | localizedName:'content' }}</p>
              }
            </div>
          }

          @if (product()?.variants && product()!.variants!.length > 0) {
            <div class="variant-selector">
              <span class="variant-label">{{ 'Size' | transloco }}:</span>
              <div class="variant-options">
                @for (variant of product()!.variants; track variant.appId) {
                  <button
                    class="variant-btn"
                    [class.active]="selectedVariant()?.appId === variant.appId"
                    [class.unavailable]="variant.available === false"
                    [disabled]="variant.available === false"
                    (click)="selectVariant(variant)">
                    {{ variant.size }}
                  </button>
                }
              </div>
            </div>
          } @else if (product()?.size) {
            <div class="variant-selector">
              <span class="variant-label">{{ 'Size' | transloco }}:</span>
              <div class="variant-options">
                <button class="variant-btn active">
                  {{ product()?.size }}
                </button>
              </div>
            </div>
          }

          <div class="actions">
            @if (isDiscontinued()) {
              <button class="add-to-bag-btn discontinued-btn" disabled>
                <i class="ri-forbid-2-line"></i>
                <span>{{ 'Discontinued' | transloco }}</span>
              </button>
            } @else if (isOutOfStock()) {
              <button class="add-to-bag-btn out-of-stock-btn" disabled>
                <i class="ri-close-circle-line"></i>
                <span>{{ 'OutOfStock' | transloco }}</span>
              </button>
            } @else {
              <button class="add-to-bag-btn" (click)="addProductInCart()">
                <i class="ri-shopping-bag-line"></i>
                <span>{{ 'Add to Cart' | transloco }}</span>
              </button>
            }

            <div class="secondary-actions">
              <button class="btn-secondary btn-wishlist" [class.active]="isFavorite()" (click)="toggleWishlist()">
                <i [class]="isFavorite() ? 'ri-heart-fill' : 'ri-heart-line'"></i>
                {{ isFavorite() ? ('InFavorites' | transloco) : ('AddToFavorites' | transloco) }}
              </button>

              <button class="btn-secondary" (click)="shareModal.open()">
                <i class="ri-share-line"></i>
                {{ 'Share' | transloco }}
              </button>
            </div>
          </div>
        </div>
    </div>

    <recommended-products [productId]="product()?.id || ''" (addTopBag)="addProductInCart()" (addToWishlist)="toggleWishlist()"/>

    <recently-viewed [excludeProductId]="product()?.id || ''"/>
  </section>
}
<app-share-modal #shareModal/>
